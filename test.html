<body>
<script>let input = document.createElement("input"),
    albums = [],
    tracks = {},
    audio = document.createElement("audio"),
    title = document.createElement("div"),
    titleA = document.createElement("a"),
    artist = document.createElement("h3"),
    albumP = document.createElement("a"),
    smallAlbumImage = document.createElement("img"),
    ctime = document.createElement("p"),
    duration = document.createElement("p"),
    coverDiv = document.createElement("div"),
    favicon = document.createElement("link"),
    currentTrack = undefined,
    currentFullTrack = undefined,
    currentAlbum = undefined,
    currentMenu = undefined,
    shuffle = true,
    prevTracks = [],
    nextTracks = [],
    statusLabel = document.createElement("p"),
    keyGen = 0;

statusLabel.classList.add("btnStop");
statusLabel.style.display = "inline";
document.body.appendChild(statusLabel);
document.body.appendChild(albumP);
document.body.appendChild(ctime);
document.body.appendChild(duration);
audio.onplay = () => {
    statusLabel.style.display = "none";
};
audio.onpause = () => {
    statusLabel.style.display = "inline";
};
favicon.rel = "shortcut icon";
document.head.appendChild(favicon);

function createP(parentElement, innerHTML, onclick) {
    let p = document.createElement("p");
    p.innerHTML = innerHTML;
    p.classList.add("track-select");
    p.style.display = "inline";
    p.onclick = onclick;
    parentElement.appendChild(p);
    return p;
}

//making the menu
let menuDiv = document.createElement("div");
(() => {
    //button to play a track next
    createP(menuDiv, "Play Next", () => {
        nextTracks.unshift(getMenu());
    });
    br(menuDiv);
    //button to add a track to the end of the queue
    createP(menuDiv, "Add to Queue", () => {
        nextTracks.push(getMenu());
    });
    br(menuDiv);
    //button to completely remove a track
    createP(menuDiv, "Remove", () => {
        let q = tracks[getMenu()];
        albums[q[3]][3][q[2]] = null;
        delete tracks[getMenu()];
        menuDiv.parentElement.parentElement.removeChild(menuDiv.parentElement);
        currentMenu = undefined;
    });
})();
function getMenu() {
    return currentMenu;
}

//controls (so you don't always have to use the mediacontrols, which are less convenient when you're on the page)
let buttonsDiv = document.createElement("div");
//back a track
createP(buttonsDiv, "\u23ee", prevSong);
//back 5 seconds
createP(buttonsDiv, "\u23ea", () => {
    audio.currentTime -= 5;
});
//buttonsDiv.appendChild(audio);
//forwards 5 seconds
createP(buttonsDiv, "\u23e9", () => {
    audio.currentTime += 5;
});
//forwards a track
createP(buttonsDiv, "\u23ed", nextSong);
let shuffleButton = createP(buttonsDiv, "\ud83d\udd00", () => {
    shuffle = !shuffle;
    shuffleButton.innerHTML = shuffle ? "\ud83d\udd00" : "\ud83d\udd01";
});
buttonsDiv.classList.add("buttons-div");

audio.controls = 1;
audio.volume = 0.5;
ctime.style.display = "none";
ctime.classList.add("start");
duration.style.display = "none";
duration.classList.add("finish");
audio.classList.add("ctl");
audio.id = "player";
coverDiv.classList.add("thumbnail");
smallAlbumImage.style.width = smallAlbumImage.style.height = 200;
artist.id = "newPlayerArtistName";
title.classList.add("tracktitle");
albumP.classList.add("albumtitle");
title.appendChild(titleA);
function br(element = document.body) {
    element.appendChild(document.createElement("br"));
}

document.body.appendChild(input);
br();
document.body.appendChild(coverDiv);
coverDiv.appendChild(smallAlbumImage);
document.body.appendChild(title);
document.body.appendChild(artist);
document.body.appendChild(audio);
document.body.appendChild(buttonsDiv);
br();

function getAlbums() {
    return albums;
}

async function addAlbum(input) {
    let linku = input.value;
    await fetch(linku)
        .then((i) => i.text())
        .then((i) => {
        let desc = i.match(
            /<meta name="description" content="\n?([^]+?)\n?">/
        )[1],
            image = i.match(
                /<a class="popupImage"[^]+?<img src="(.+?)"/
            )[1],
            tralbumData = JSON.parse(
                i
                .match(/data-tralbum="(.+?\})"/)[1]
                .replaceAll("&quot;", '"')
                .replaceAll("&#39;", "'")
                .replaceAll("\n", "<br>")
                .replaceAll("&amp;", "&")
            ),
            trackInfo = tralbumData.trackinfo,
            cover = document.createElement("img"),
            p = document.createElement("div"),
            albumDiv = document.createElement("div"),
            al = albums.length,
            num = true;

        for (let j in trackInfo) {
            if (trackInfo[j].title.match(/^\d/) == null) {
                num = false;
                break;
            }
        }

        for (let j in trackInfo) {
            if (trackInfo[j]?.file?.["mp3-128"]) {
                let itemDiv = document.createElement("div"),
                    a = document.createElement("p"),
                    menu = document.createElement("p"),
                    parsedTitle = num
                ? trackInfo[j].title.match(
                    /^\d*?(?:\. | |\.)(.+) - (.+?)$/
                )
                : trackInfo[j].title.match(/^(.+) - (.+?)$/),
                    trackArtist =
                    trackInfo[j].artist ||
                    parsedTitle?.[1] ||
                        tralbumData.artist,
                        trackTitle = parsedTitle?.[2] || trackInfo[j].title,
                            tracksLen = keyGen;
                tracks[keyGen] = [
                    trackArtist,
                    trackTitle,
                    j,
                    albums.length,
                    image,
                ];
                a.onclick = () => {
                    playSong(tracksLen);
                };
                keyGen++;
                a.innerHTML = trackInfo[j].title;
                menu.innerHTML = " >";
                menu.style.display = a.style.display = "inline";
                menu.onclick = (e) => {
                    e.preventDefault();
                    if (currentMenu != tracksLen) {
                        if (currentMenu != undefined) {
                            menuDiv.parentElement.children[1].innerHTML =
                                " >";
                            menuDiv.parentElement.removeChild(menuDiv);
                        }
                        itemDiv.appendChild(menuDiv);
                        currentMenu = tracksLen;
                        menu.innerHTML = " v";
                    } else {
                        menu.innerHTML = " >";
                        menuDiv.parentElement.removeChild(menuDiv);
                        currentMenu = undefined;
                    }
                };
                a.classList.add("track-select");
                menu.classList.add("track-select");
                itemDiv.appendChild(a);
                itemDiv.appendChild(menu);
                p.appendChild(itemDiv);
            }
        }
        albums.push([image, tralbumData, cover, trackInfo, linku]);
        audio.controls = true;
        cover.src = image;
        cover.onclick = () => {
            refetchAlbum(al);
        };
        cover.title =
            "Click to re-fetch the track links for this album! (in case playing stops working)";
        albumDiv.album = linku;
        albumDiv.appendChild(cover);
        albumDiv.appendChild(p);
        document.body.appendChild(albumDiv);
        input.value = "";
    });
    return;
}

async function refetchAlbum(al) {
    await fetch(albums[al][4])
        .then((i) => i.text(), () => {})
        .then((i) => {
        let tralbumData = JSON.parse(
            i
            .match(/data-tralbum="(.+?\})"/)[1]
            .replaceAll("&quot;", '"')
            .replaceAll("&#39;", "'")
            .replaceAll("\n", "<br>")
            .replaceAll("&amp;", "&")
        ),
            trackInfo = tralbumData.trackinfo;
        albums[al][1] = tralbumData;
        albums[al][3] = trackInfo;
    }, () => {});
    return;
}

document.addEventListener("keydown", (e) => {
    if (e.key == "Enter") {
        addAlbum(input);
    }
});
audio.addEventListener("ended", nextSong);
audio.ontimeupdate = () => {
    ctime.innerHTML = tformat(audio.currentTime, audio.duration);
    duration.innerHTML = tformat(audio.duration, audio.duration);
};
if ("mediaSession" in navigator) {
    navigator.mediaSession.setActionHandler("seekbackward", function () {
        audio.currentTime -= 5;
    });
    navigator.mediaSession.setActionHandler("seekforward", function () {
        audio.currentTime += 5;
    });
    navigator.mediaSession.setActionHandler("previoustrack", prevSong);
    navigator.mediaSession.setActionHandler("nexttrack", nextSong);
}

function nextSong() {
    prevTracks.push(currentFullTrack);
    if (nextTracks.length > 0) {
        let t = nextTracks.shift();
        playSong(t);
    } else {
        let keys = Object.keys(tracks);
        if (shuffle) {
            let t = (t2 = keys.indexOf(currentFullTrack));
            while (t == t2) {
                t = (Math.random() * keys.length) | 0;
            }
            playSong(keys[t]);
        }
        if (!shuffle) {
            let t = 0;
            if (+keys[keys.length - 1] > +currentFullTrack) {
                for (; +keys[t++] < +currentFullTrack && t < keys.length; );
            }
            playSong(keys[t]);
        }
    }
}

async function easyBulkAdd(array) {
    if (array.length) {
        await addAlbum({ value: array.shift() });
        setTimeout(() => {
            easyBulkAdd(array);
        }, 500);
    }
}

function prevSong() {
    if (audio.currentTime > 5 || prevTracks.length == 0) {
        audio.src = "";
        playSong(currentFullTrack);
    } else {
        let t = prevTracks.pop();
        nextTracks.unshift(currentFullTrack);
        playSong(t);
    }
}

async function playSong(t) {
    let trackArray = tracks[t];
    currentFullTrack = t;
    console.log(t);
    currentTrack = trackArray[2];
    currentAlbum = trackArray[3];
    //making sure that the song can be played
    if (
        albums[currentAlbum][3][currentTrack]["file"]["mp3-128"].match(
            /ts=(.+?)\&/
        )[1] *
        1000 -
        Date.now() <
        5000000
    ) {
        await refetchAlbum(currentAlbum);
    }
    audio.src = albums[currentAlbum][3][currentTrack]["file"]["mp3-128"];
    titleA.innerHTML = trackArray[1];
    artist.innerHTML = trackArray[0];
    audio.currentTime = 0;
    audio.play();
    update(trackArray[4], trackArray);
}

function update(image, trackArray) {
    smallAlbumImage.src = image;
    if ("mediaSession" in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: trackArray[1],
            artist: trackArray[0],
            artwork: [{ src: image }],
        });
    }
    duration.innerHTML = tformat(audio.duration, audio.duration);
    favicon.href = image;

    albumP.title = albums[currentAlbum][1].current.title;
    statusLabel.style.display = "inline";
}

function tformat(t, l) {
    let hr = "",
        mn = ("0" + (((t / 60) | 0) % 60) + ":").slice(-3),
        sc = ("0" + (t % 60 | 0)).slice(-2);
    if (l > 3600) {
        hr = ("0" + ((t / 3600) | 0) + ":").slice(-3);
    }
    return hr + mn + sc;
}</script>
	<style>p.track-select{margin-block-end: 0px; margin-block-start: 0px; width: fit-content} p.track-select:hover{cursor: pointer} p#statusLabel{display: hidden} .buttons-div p{font-size: 48; vertical-align: text-bottom}</style>
</body>
